<html>
	<head>
		<script src="jquery-1.7.min.js" type="text/javascript"></script>
		<script src="lib.js" type="text/javascript"></script>
		<script type="text/javascript">
				
				function add(){
					sendAlert("Слово добавлено на сервер");
				};
		
				//проверяет подошел ли логин и пароль
				//тут не нужна т.к уже проверили в настройках
				//но стои сделать проверку на доступность сервера
				
				function checkAuthData(success){
				};
				
				//загружаем языки
				function setLanguages(languages){
					//а если нету языков ?
					languages.languages.forEach(function(item){
						$('#languages').append( $('<option value="'+item.id+'">'+item.name+'</option>'));
						}
					)
				};
				
				
				//функция добавления слова на сервер
				function addWordToServer(){
				//навести порядок
				if($('#word').attr('value') == ""){
					sendAlert("Поле Слово пустое"); return;
				}
				if($('#translate').attr('value') == ""){
					sendAlert("Поле Перевод пустое"); return;
				}
				//формируем данные для отправки
				//пока так пока не добьюсь работоспособности
				//так же надо добавить проверку на пустоту строк
				SMDServer.auth(checkAuthData);
				var date = new Date().getTime();
				var word = [];
				word.push({
					translation : $('#word').attr('value'), 
				    original : escapeToUtf16($('#translate').attr('value')), 
				    rating :0,
					modified: date
				});
				var data = {
					currentDeviceTime: date,
					languages :[{
						id :$('#languages :selected').val(),
						name : $('#languages :selected').text(),
						words : word 
				     }]
				};
				//sendAlert(JSON.stringify(data));
				SMDServer.addWords(data,add);
			
				
						
						
				};

				//при запуске popup об этом посылается сообщения на фоновую страницу
				window.addEventListener("load", function(){
					chrome.extension.sendRequest({message : "StartPopup"}, function(Response){
					// и получаем ответ в котором содежится выделеный текст
					document.getElementById('word').value = Response.nowText;
					
					//так же надо добавить анимацию пока все загружаем
					
					//тут проверяем сохранен ли логин или пароль, если да 
					//загружаем список языков
					//и отображем форму с выделеным словом
					if(localStorage["auth"] =="true"){
							SMDServer.setAuthData(localStorage["login"],localStorage["password"]);
							SMDServer.auth(checkAuthData);
							SMDServer.loadLanguages(setLanguages);
					}else{
						//если нет то отображем введите логин и пароль в настройках
						sendAlert("вы не авторизованы");
					}
				
					});
				}, true)
		</script>
	</head>
	<!-- Cделать динамичную форму-->
	<body>

		<div>
			<div id="add_word">
				<table>
					<tr>
						<td>Слово</td>
						<td>Язык</td>
						<td>Перевод</td>
					</tr>
		
					<tr>
						<td><input type=text id="word" value=""></td>
						<td><select name="ComboBox" id="languages"></select></td>
					<td><input type=text id="translate" value=""></td>
					</tr>
		
					<tr>
					<td></td>
					<td><!--<input type=button name="translate" value="Пепевести">--></td>
					<td align=right><input type=button name="add" value="Добавить" onclick="addWordToServer()"></td>
					</tr>
				</table>
			    
 
     </body>
<html>